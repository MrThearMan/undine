<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>GraphQL over Server-Sent Events testing (Distinct Connections)</title>
  <style>
    body {
      background: hsl(219, 29%, 18%);
      color: hsl(219, 29%, 78%);
      font-family: system-ui, sans-serif;
    }
    h1 { color: hsl(219, 29%, 78%); }
    a { color: hsl(338, 100%, 67%); display: block; }
    textarea {
      background: hsl(219, 29%, 14%);
      color: hsl(219, 29%, 78%);
      border: 1px solid hsla(219, 29%, 78%, 0.15);
      font-family: monospace;
    }
    button {
      background: hsla(219, 29%, 78%, 0.15);
      color: hsl(219, 29%, 78%);
      border: 1px solid hsla(219, 29%, 78%, 0.15);
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background: hsla(219, 29%, 78%, 0.25); }
  </style>
</head>
<body>

<h1>GraphQL over Server-Sent Events testing (Distinct Connections)</h1>
<textarea id="log" cols="120" rows="50"></textarea>
<br>
<button id="send-subscribe-1">Subscribe [1]</button>
<button id="close-event-source-1">Close Source [1]</button>
<button id="send-subscribe-2">Subscribe [2]</button>
<button id="close-event-source-2">Close Source [2]</button>
<button id="clear">Clear</button>
<a style="margin-top: 1rem" href="{% url 'sse_testing_sc' %}">Test Single Connection mode</a>

<script>
  function createEventSource(label) {
    const currentURL = new URL(window.location.href)

    currentURL.pathname = "/graphql/async/";
    currentURL.searchParams.set("query", "subscription { countdown }");
    const url = currentURL.href;

    console.log("Connecting to", url);
    const source = new EventSource(url);
    console.log("Connected to", url);

    source.addEventListener("next", (e) => {
      console.log("Received next message", e);
      document.querySelector("#log").value += ("Received " + label + ": " + e.data + "\n");
    });

    source.addEventListener("complete", (e) => {
      console.log("Received completed message", e);
      document.querySelector("#log").value += ("Completed " + label + "\n");
      source.close();
    });

    source.addEventListener("open", (e) => {
      console.log("EventSource open", e);
      document.querySelector("#log").value += ("Opened " + label + "\n");
    });

    source.addEventListener("error", async (e) => {
      console.error("EventSource error", e);
      if (source.readyState === EventSource.CLOSED) {
        try {
          const resp = await fetch(url, { headers: { "Accept": "text/event-stream" } });
          if (!resp.ok) {
            const text = await resp.text();
            document.querySelector("#log").value += (
              "Error " + label + ": " + resp.status + " " + resp.statusText + " â€” " + text + "\n"
            );
            return;
          }
        } catch (_) {}
      }
      document.querySelector("#log").value += ("Error " + label + "\n");
    });

    return source;
  }

  /** @type {EventSource} */
  let eventSource1;
  /** @type {EventSource} */
  let eventSource2;

  window.addEventListener("beforeunload", (e) => {
    console.log("Closing before unload", e);
    if (eventSource1 !== undefined) {
      eventSource1.close();
    }
    if (eventSource2 !== undefined) {
      eventSource2.close();
    }
  });

  function tryCreateSource(label, current) {
    if (current === undefined || current.readyState === EventSource.CLOSED) {
      return createEventSource(label);
    }
    const state = current.readyState === EventSource.CONNECTING ? "still connecting" : "connection open";
    console.log("Cannot create new source " + label + ":", state);
    document.querySelector("#log").value += ("Cannot create new source " + label + ": " + state + "\n");
    return current;
  }

  function tryCloseSource(label, current) {
    if (current === undefined || current.readyState === EventSource.CLOSED) {
      console.log("Source " + label + " already closed");
      document.querySelector("#log").value += ("Source " + label + " already closed\n");
      return;
    }
    console.log("Closed " + label + " manually");
    document.querySelector("#log").value += ("Closed " + label + " manually\n");
    current.close();
  }

  document.querySelector("#send-subscribe-1").onclick = async (e) => {
    eventSource1 = tryCreateSource("[1]", eventSource1);
  };

  document.querySelector("#close-event-source-1").onclick = (e) => {
    tryCloseSource("[1]", eventSource1);
  };

  document.querySelector("#send-subscribe-2").onclick = async (e) => {
    eventSource2 = tryCreateSource("[2]", eventSource2);
  };

  document.querySelector("#close-event-source-2").onclick = (e) => {
    tryCloseSource("[2]", eventSource2);
  };

  document.querySelector("#clear").onclick = (e) => {
    document.querySelector("#log").value = "";
  };
</script>

</body>
</html>
