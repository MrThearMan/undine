<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>Lifecycle Hooks - Undine</title>
<link href="../css/theme.css" rel="stylesheet"/>
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/docs.css" rel="stylesheet"/>
<link href="../css/pygments.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Lifecycle Hooks";
        var mkdocs_page_input_path = "lifecycle-hooks.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
<meta content="Documentation on lifecycle hooks in Undine." name="description"/></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Undine
        </a><div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="..">Home</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/">Tutorial</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../schema/">Schema</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../queries/">Queries</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mutations/">Mutations</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filtering/">Filtering</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ordering/">Ordering</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pagination/">Pagination</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../subscriptions/">Subscriptions</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../global-object-ids/">Global Object IDs</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../file-upload/">File Upload</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../persisted-documents/">Persisted Documents</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../interfaces/">Interfaces</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unions/">Unions</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scalars/">Scalars</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../directives/">Directives</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hacking-undine/">Hacking Undine</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimizer/">Optimizer</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../async/">Async Support</a>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal current" href="#">Lifecycle Hooks</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#lifecyclehook">LifecycleHook</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lifecyclehookcontext">LifecycleHookContext</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../validation-rules/">Validation Rules</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../integrations/">Integrations</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/">FAQ</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/">Contributing</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Undine</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href=".."></a></li>
<li class="breadcrumb-item active">Lifecycle Hooks</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="lifecycle-hooks">Lifecycle Hooks<a class="headerlink" href="#lifecycle-hooks" title="Permanent link">ðŸ”—</a></h1>
<p>In this section, we'll cover Undine's lifecycle hooks, which allow you to hook into the
execution of a GraphQL request.</p>
<h2 id="lifecyclehook">LifecycleHook<a class="headerlink" href="#lifecyclehook" title="Permanent link">ðŸ”—</a></h2>
<p>A GraphQL operation is executed in a series of steps. These steps are:</p>
<ol>
<li><strong>Parsing</strong> the GraphQL source document to a GraphQL AST.</li>
<li><strong>Validation</strong> of the GraphQL AST against the GraphQL schema.</li>
<li><strong>Execution</strong> of the GraphQL operation.</li>
</ol>
<p><code>LifecycleHooks</code> allow you to hook into the these steps to run custom logic
before or after each of these steps, or before and after the whole operation.
Here is a basic example of a <code>LifecycleHook</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleHook</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExampleHook</span><span class="p">(</span><span class="n">LifecycleHook</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"before"</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="k">yield</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"after"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>To implement a hook, you need to create a class that inherits from <code>LifecycleHook</code>
and implement the <code>run</code> method. <code>run</code> should be a generator function that yields
once, marking the point in which the hook should run. Anything before the yield
statement will be executed before the hooking point, and anything after the yield
statement will be executed after the hooking point.</p>
<p>You can add this hook the different steps using settings:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">UNDINE</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="s2">"PARSE_HOOKS"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"path.to.ExampleHook"</span><span class="p">],</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="s2">"VALIDATION_HOOKS"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"path.to.ExampleHook"</span><span class="p">],</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="s2">"EXECUTION_HOOKS"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"path.to.ExampleHook"</span><span class="p">],</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="s2">"OPERATION_HOOKS"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"path.to.ExampleHook"</span><span class="p">],</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When multiple hooks are registered for the same hooking point, they will be run
in the order they are registered. This means that the first hook registered will
have its "before" portion run first and its "after" portion run last. You can think
of them as a stack of context managers.</p>
<p>Lifecycle hooks can have a different implementation in <a href="../async/">async context</a>
using the <code>run_async</code> method. If no async implementation is provided,
the synchronous version will be used.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span><span class="p">,</span> <span class="n">Generator</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleHook</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExampleHook</span><span class="p">(</span><span class="n">LifecycleHook</span><span class="p">):</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"before"</span><span class="p">)</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="k">yield</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"after"</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"before async"</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="k">yield</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"after async"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Async hooks are also used for <a href="../subscriptions/">subscriptions</a>.</p>
<h2 id="lifecyclehookcontext">LifecycleHookContext<a class="headerlink" href="#lifecyclehookcontext" title="Permanent link">ðŸ”—</a></h2>
<p>Each hook is passed a <code>LifecycleHookContext</code> object (<code>self.context</code>),
which contains information about the current state of the GraphQL request.
This includes:</p>
<ul>
<li><code>source</code>: Source GraphQL document string.</li>
<li><code>document</code>: Parsed GraphQL document AST. Available after parsing is complete.</li>
<li><code>variables</code>: Variables passed to the GraphQL operation.</li>
<li><code>operation_name</code>: The name of the GraphQL operation.</li>
<li><code>extensions</code>: GraphQL operation extensions received from the client.</li>
<li><code>request</code>: Django request during which the GraphQL request is being executed.</li>
<li><code>result</code>: Execution result of the GraphQL operation.</li>
</ul>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">ðŸ”—</a></h2>
<p>Here's some more complex examples of possible lifecycle hooks.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">graphql</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExecutionResult</span><span class="p">,</span> <span class="n">GraphQLError</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleHook</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorEnrichmentHook</span><span class="p">(</span><span class="n">LifecycleHook</span><span class="p">):</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="sd">"""Catch errors and enrich them with status codes and error codes."""</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>            <span class="k">yield</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="c1"># Catch all exceptions raised in the hooking point and turn them into ExecutionResults.</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>            <span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"status_code"</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">"error_code"</span><span class="p">:</span> <span class="s2">"INTERNAL_SERVER_ERROR"</span><span class="p">}</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>            <span class="n">new_error</span> <span class="o">=</span> <span class="n">GraphQLError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="n">extensions</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">ExecutionResult</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="p">[</span><span class="n">new_error</span><span class="p">])</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>            <span class="k">return</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>            <span class="k">return</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>        <span class="c1"># Enrich errors with status codes and error codes.</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>                <span class="n">error</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>            <span class="n">error</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"status_code"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a>            <span class="n">error</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"error_code"</span><span class="p">,</span> <span class="s2">"INTERNAL_SERVER_ERROR"</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">graphql</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExecutionResult</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine.hooks</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleHook</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CachingHook</span><span class="p">(</span><span class="n">LifecycleHook</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="sd">"""Cache execution results."""</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>        <span class="n">was_cached</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>        <span class="c1"># Check if the result is already cached.</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>            <span class="n">was_cached</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>            <span class="c1"># Setting results early will cause the hooking point to not run</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>            <span class="c1"># and the graphql execution to exit early with this result.</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">ExecutionResult</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="k">yield</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="c1"># If results where cached, the hooking point will not run, but the</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="c1"># hook's "after" portion will. Therefore, don't re-cache the result</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="c1"># if it was already cached.</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>        <span class="k">if</span> <span class="n">was_cached</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>            <span class="k">return</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../async/" title="Async Support"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../validation-rules/" title="Validation Rules">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span><a href="../async/" style="color: #fcfcfc">Â« Previous</a></span>
<span><a href="../validation-rules/" style="color: #fcfcfc">Next Â»</a></span>
</span>
</div>
<script src="../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "..";</script>
<script src="../js/theme_extra.js"></script>
<script src="../js/theme.js"></script>
<script src="../js/docs.js"></script>
<script src="../service-worker.js"></script>
<script src="../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
</body>
</html>
