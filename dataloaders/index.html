<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>DataLoaders - Undine</title>
<link href="../css/theme.css" rel="stylesheet"/>
<link href="../css/theme_extra.css" rel="stylesheet"/>
<link href="../css/docs.css" rel="stylesheet"/>
<link href="../css/pygments.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "DataLoaders";
        var mkdocs_page_input_path = "dataloaders.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
<meta content="DataLoader support in Undine" name="description"/></head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href=".."> Undine
        </a><div role="search">
<form action="../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="..">Home</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/">Tutorial</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../schema/">Schema</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../queries/">Queries</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mutations/">Mutations</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filtering/">Filtering</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ordering/">Ordering</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pagination/">Pagination</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../subscriptions/">Subscriptions</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../global-object-ids/">Global Object IDs</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../file-upload/">File Upload</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../persisted-documents/">Persisted Documents</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../interfaces/">Interfaces</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unions/">Unions</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scalars/">Scalars</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../directives/">Directives</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hacking-undine/">Hacking Undine</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optimizer/">Optimizer</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../async/">Async Support</a>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal current" href="#">DataLoaders</a>
<ul class="current">
<li class="toctree-l2"><a class="reference internal" href="#dataloader">DataLoader</a>
<ul>
<li class="toctree-l3"><a class="reference internal" href="#returning-errors">Returning errors</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#max-batch-size">Max batch size</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reusing-loads">Reusing loads</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#priming-loads">Priming loads</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#clearing-loads">Clearing loads</a>
</li>
<li class="toctree-l3"><a class="reference internal" href="#custom-key-hash-function">Custom key hash function</a>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#technical-details">Technical Details</a>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lifecycle-hooks/">Lifecycle Hooks</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../validation-rules/">Validation Rules</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../integrations/">Integrations</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/">FAQ</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing/">Contributing</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="..">Undine</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href=".."></a></li>
<li class="breadcrumb-item active">DataLoaders</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="dataloaders">DataLoaders<a class="headerlink" href="#dataloaders" title="Permanent link">ðŸ”—</a></h1>
<p>In this section, we'll cover Undine's <code>DataLoader</code>, which is a utility for loading data in batches.
<code>DataLoaders</code> can be used to optimize the performance of queries that require I/O operations,
like fetching data from an external API.</p>
<p><code>DataLoaders</code> are implemented using python's <a href="https://docs.python.org/3/library/asyncio.html" target="_blank">asyncio</a> library,
so you'll need to turn on Undine's <a href="../async/">async support</a> to use them.</p>
<blockquote>
<p>In most cases, using <code>DataLoaders</code> to optimize database queries is not necessary,
as Undine's <a href="../optimizer/">Optimizer</a> already handles this for you.</p>
</blockquote>
<h2 id="dataloader">DataLoader<a class="headerlink" href="#dataloader" title="Permanent link">ðŸ”—</a></h2>
<p>A <code>DataLoader</code> always requires a "load function" (<code>load_fn</code>) which implements the actual logic for fetching data.
This function receives a list of "keys" that identify the data that should be fetched.
Let's look at an example which fetches a list of pokemon from an external API by their name.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="hll"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
</span><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="hll">    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://pokeapi.co/api/v2/pokemon/</span><span class="si">{pokemon_name}</span><span class="s2">"</span>
</span><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="hll">
</span><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="hll">    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
</span><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="hll">        <span class="n">requests</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pokemon_name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
</span><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="hll">        <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">requests</span><span class="p">)</span>
</span><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="hll">
</span><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="hll">    <span class="c1"># Validation skipped for brevity</span>
</span><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="hll">    <span class="k">return</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
</span><a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">return</span> <span class="n">pokemon_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Here, the <code>DataLoader</code> load function <code>load_pokemon</code> receives a list of keys (pokemon names in this case)
and makes an equal number of concurrent HTTP requests to an external API to fetch these pokemon information.</p>
<p>The keys which the load function receives for a given GraphQL operation are defined by
calls to <code>DataLoader.load</code>, like in the <code>pokemon_by_name</code> <code>Entrypoint</code> resolver in the above example.
Note that the resolver returns a <a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" target="_blank"><code>Future</code></a> object from the <code>DataLoader</code>,
and that the function is not async â€” this is important for the <code>DataLoader</code> to work correctly.
This is discussed more thoroughly in the <a href="#technical-details">Technical Details</a> section.</p>
<p>Given the above setup, if you query <code>pokemon_by_name</code> multiple times like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">query</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nl">slotOne</span><span class="p">:</span><span class="w"> </span><span class="n">pokemonByName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s">"pikachu"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="n">id</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">name</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">height</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">weight</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="nl">slotTwo</span><span class="p">:</span><span class="w"> </span><span class="n">pokemonByName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s">"eevee"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="n">id</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="n">name</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="n">height</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="n">weight</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>DataLoader</code> will run the load function <code>load_pokemon</code> once with keys <code>["pikachu", "eevee"]</code> to fetch
pokemon information for both <code>slotOne</code> and <code>slotTwo</code>.</p>
<p>Note that the load function needs to return the loaded values in the same order that it received the keys in,
so that the values can be matched up with the keys by the <code>DataLoader</code>. You also cannot return less or more
values than the number of keys you received.</p>
<h3 id="returning-errors">Returning errors<a class="headerlink" href="#returning-errors" title="Permanent link">ðŸ”—</a></h3>
<p>If the load for a particular key fails, you can return an exception from the load function for that key.
This exception will be converted into a GraphQL error in the response to the client.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span> <span class="o">|</span> <span class="ne">ValueError</span><span class="p">]:</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://pokeapi.co/api/v2/pokemon/</span><span class="si">{pokemon_name}</span><span class="s2">"</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pokemon_name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>        <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="hll">    <span class="c1"># Validation skipped for brevity</span>
</span><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="hll">    <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Pokemon not found"</span>
</span><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="hll">    <span class="k">return</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="k">else</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
</span><a id="__codelineno-2-23" name="__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="n">pokemon_by_name</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="k">return</span> <span class="n">pokemon_by_name</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Note that in this case the <code>Entrypoint</code> is made nullable so that only the requests for pokemon that fail to load
will return <code>null</code> with an error, and the rest will return the loaded pokemon information.
For example, given the query we defined above, if load for <code>slotOne</code> fails, the response will be:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="nt">"slotOne"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="nt">"slotTwo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">      </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">      </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eevee"</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">      </span><span class="nt">"height"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">      </span><span class="nt">"weight"</span><span class="p">:</span><span class="w"> </span><span class="mi">65</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">  </span><span class="nt">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">      </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pokemon not found"</span><span class="p">,</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"slotOne"</span><span class="p">]</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">  </span><span class="p">]</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="max-batch-size">Max batch size<a class="headerlink" href="#max-batch-size" title="Permanent link">ðŸ”—</a></h3>
<p>By default, a <code>DataLoader</code> will load all keys requested in a GraphQL operation in a single batch.
If you want to limit the number of keys that are loaded in a single batch, you can use the <code>max_batch_size</code> parameter.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="hll"><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>In this case, limiting the maximum batch size will ensure that we don't send too many
concurrent requests to the external API, which can help avoid timeouts and rate limits.</p>
<h3 id="reusing-loads">Reusing loads<a class="headerlink" href="#reusing-loads" title="Permanent link">ðŸ”—</a></h3>
<p>By default, if a <code>DataLoader</code> receives a request to load the same key multiple times,
it will reuse the previous load and share the result between them. For example, if you
query the <code>pokemon_by_name</code> <code>Entrypoint</code> with the following query:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span>
<span class="normal"><a href="#__codelineno-5-7">7</a></span>
<span class="normal"><a href="#__codelineno-5-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">query</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nl">slotOne</span><span class="p">:</span><span class="w"> </span><span class="n">pokemonByName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s">"pikachu"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="n">name</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nl">slotTwo</span><span class="p">:</span><span class="w"> </span><span class="n">pokemonByName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="s">"pikachu"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">name</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>DataLoader</code> will run the load function <code>load_pokemon</code> once with keys <code>["pikachu"]</code> and reuse the result
for both <code>slotOne</code> and <code>slotTwo</code>. Reuse will happen even if the load happens in a different batches when
a <a href="#max-batch-size"><code>max_batch_size</code></a> has been set.</p>
<p>If you want to disable reuse, you can set the <code>reuse_loads</code> parameter to <code>False</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="hll"><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">,</span> <span class="n">reuse_loads</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This will result in the <code>DataLoader</code> running the load function <code>load_pokemon</code> with keys <code>["pikachu", "pikachu"]</code> instead,
where the first key matches load for <code>slotOne</code> and the second for <code>slotTwo</code>.</p>
<p>Note that reused loads should not be treated as a cache, as they are not shared between requests
or web service workers. Since load reuse stores <a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" target="_blank"><code>Future</code></a> objects
(see <a href="#technical-details">Technical Details</a>), it's much easier to add caching in the load function
or in application code using Django's cache API.</p>
<h3 id="priming-loads">Priming loads<a class="headerlink" href="#priming-loads" title="Permanent link">ðŸ”—</a></h3>
<p>When <code>DataLoader</code> <a href="#reusing-loads">load reuse</a> is enabled, you can prime the <code>DataLoader</code> with completed load results
for specific keys without going through the load function. This way if a load would be requested
for a primed key, that primed value would be returned immediately. If batch size is limited using
<a href="#max-batch-size"><code>max_batch_size</code></a>, that load would also not contribute to the size of the batch.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="n">pikachu</span> <span class="o">=</span> <span class="n">Pokemon</span><span class="p">(</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="nb">id</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">"pikachu"</span><span class="p">,</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>    <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>    <span class="n">weight</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="hll">        <span class="k">return</span> <span class="n">pokemon_loader</span><span class="o">.</span><span class="n">prime</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">"pikachu"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">pikachu</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Priming can also be useful when loads for the same object can happen by different keys,
for example, if loads for a pokemon can happen by the pokemon's name or its ID.
In this case, you should also provide a common <code>asyncio.Lock</code> for the <code>DataLoaders</code> so
that one load function can run before the other load functions. You might also want to set
the <code>can_prime_pending_loads</code> parameter to <code>True</code> so that already pending loads from the
other <code>DataLoaders</code> can be set.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon_by_id</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://pokeapi.co/api/v2/pokemon/</span><span class="si">{pokemon_id}</span><span class="s2">"</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pokemon_id</span><span class="o">=</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>    <span class="c1"># Validation skipped for brevity</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>    <span class="c1"># Prime the name loader with the fetched data</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="hll">    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="hll">    <span class="n">pokemon_name_loader</span><span class="o">.</span><span class="n">prime_many</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">can_prime_pending_loads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="hll">    <span class="k">return</span> <span class="n">data</span>
</span><a id="__codelineno-8-31" name="__codelineno-8-31"></a>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon_by_name</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a>    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">"https://pokeapi.co/api/v2/pokemon/</span><span class="si">{pokemon_name}</span><span class="s2">"</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>        <span class="n">requests</span> <span class="o">=</span> <span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pokemon_name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a>        <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a>    <span class="c1"># Validation skipped for brevity</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a>    <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a>    <span class="c1"># Prime the ID loader with the fetched data</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="hll">    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pokemon</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</span><a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="hll">    <span class="n">pokemon_id_loader</span><span class="o">.</span><span class="n">prime_many</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">can_prime_pending_loads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="hll">    <span class="k">return</span> <span class="n">data</span>
</span><a id="__codelineno-8-47" name="__codelineno-8-47"></a>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="hll"><span class="n">lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="hll"><span class="n">pokemon_id_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon_by_id</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">)</span>
</span><a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="hll"><span class="n">pokemon_name_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon_by_name</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">)</span>
</span><a id="__codelineno-8-52" name="__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a>        <span class="k">return</span> <span class="n">pokemon_id_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a>        <span class="k">return</span> <span class="n">pokemon_name_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="clearing-loads">Clearing loads<a class="headerlink" href="#clearing-loads" title="Permanent link">ðŸ”—</a></h3>
<p>When <code>DataLoader</code> <a href="#reusing-loads">load reuse</a> is enabled, you can also clear reused loads.
A potential use case for this would be if a mutation on the loaded data would be performed
during the GraphQL operation, and the load would therefore need to be re-fetched.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="hll">        <span class="k">return</span> <span class="n">pokemon_loader</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="custom-key-hash-function">Custom key hash function<a class="headerlink" href="#custom-key-hash-function" title="Permanent link">ðŸ”—</a></h3>
<p>When <code>DataLoader</code> <a href="#reusing-loads">load reuse</a> is enabled, loads are mapped internally by the <code>DataLoader</code>
from the load key to a <a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" target="_blank"><code>Future</code></a> object where the load result will be
stored once it's available. For the load key to be used as a key in a map, it needs to be hashable,
but you can use non-hashable keys by providing a custom key hash function (<code>key_hash_fn</code>). A key hash function
is also useful when two different objects should be considered equal when loading them using a <code>DataLoader</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">Future</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">undine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Entrypoint</span><span class="p">,</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">RootType</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Pokemon</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_pokemon</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span> <span class="o">...</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">key_hash_fn</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="hll">    <span class="k">return</span> <span class="n">key</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
</span><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="hll">
</span><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="hll">
</span><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="hll"><span class="n">pokemon_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">load_fn</span><span class="o">=</span><span class="n">load_pokemon</span><span class="p">,</span> <span class="n">key_hash_fn</span><span class="o">=</span><span class="n">key_hash_fn</span><span class="p">)</span>
</span><a id="__codelineno-10-18" name="__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">Query</span><span class="p">(</span><span class="n">RootType</span><span class="p">):</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>    <span class="nd">@Entrypoint</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pokemon_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">GQLInfo</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">Pokemon</span><span class="p">]:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>        <span class="k">return</span> <span class="n">pokemon_loader</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<h2 id="technical-details">Technical Details<a class="headerlink" href="#technical-details" title="Permanent link">ðŸ”—</a></h2>
<p>In this section, we'll go over how Undine's <code>DataLoader</code> works during a GraphQL operation.
Knowing these details can help you in debugging <code>DataLoaders</code>, but are not necessary
for getting started with them.</p>
<p>When a <code>DataLoder</code> is created, it adds a signal receiver for the <code>request_finished</code> signal.
This receiver is responsible for clearing the <code>DataLoader's</code> <a href="#reusing-loads">reusable loads</a>
when a request finishes, freeing up memory. This ensures that you can reuse the same <code>DataLoader</code>
for the next request.</p>
<p><code>DataLoaders</code> can be used in GraphQL resolvers by calling <code>load</code> on them.
This creates a new <a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future" target="_blank"><code>Future</code></a> that will be set when
the data is loaded using the <code>DataLoader</code> load function (<code>load_fn</code>). If <a href="#reusing-loads">load reuse</a>
is enabled, calling <code>load</code> might also reuse an existing <code>Future</code> created by a previous call to <code>load</code>
with the same key. The existing <code>Future</code> is likely pending, but it can be already completed
if a <a href="#max-batch-size">maximum batch size</a> has been set and the <code>Future</code> was set in a previous batch,
or it can be <a href="#priming-loads">primed</a> manually.</p>
<p>If a reusable load is found, its <code>Future</code> is returned immediately.
Otherwise, the <code>DataLoader</code> will check if a new batch needs to be created.
New batches are needed when the previous batch has already been dispatched,
or when the <a href="#max-batch-size">maximum batch size</a> has been reached.
For the first load of a new request, a new batch will always be created.
This batch is then scheduled in the event loop as a <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.Task" target="_blank"><code>Task</code></a>.</p>
<p>Whether a call to <code>DataLoder.load</code> returns an existing <code>Future</code> or creates a new one,
the resolver should then return that <code>Future</code>. During the execution of a GraphQL operation,
when a resolver returns an awaitable value (like a coroutine or <code>Future</code>), that awaitable
is wrapped in a coroutine and saved until all other fields have been resolved.
This allows all resolvers to run before any awaitables are awaited, which makes sure
that <code>DataLoaders</code> are populated from all resolvers before the event loop next runs
and any batches are dispatched.</p>
<p>Next, all these resolver coroutines are executed concurrently using <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather" target="_blank"><code>gather</code></a>,
which turns them into <code>Tasks</code> and schedules them to run in the event loop. Then, the <code>Future</code> returned by
<code>gather</code> is awaited, which hands control back to the event loop. The event loop then decides which order
it runs the batch and resolver <code>Tasks</code>. In a resolver <code>Task</code>, the resolver
will begin awaiting its awaitable, which in case of <code>DataLoader</code> is the <code>Future</code> returned by the <code>load</code>.</p>
<p>In a batch <code>Task</code>, the <code>DataLoader</code> load function is scheduled to run using yet another <code>Task</code>.
Additionally, all <code>Futures</code> in the batch that are waiting for results from the load function <code>Task</code> will have
a <a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future.add_done_callback" target="_blank">done callback</a> added at this point. This callback will cancel the load function <code>Task</code>
if any of the <code>Futures</code> waiting for its results are canceled and all other <code>Futures</code> are also done.
This can happen, for example, when a <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.TaskGroup" target="_blank"><code>TaskGroup</code></a> is canceled
due to an exception in one of its <code>Tasks</code>. Cancelling the load function <code>Task</code> in this case ensures that
it won't use resources that are no longer available (e.g. a database connection).</p>
<p>The batch <code>Task</code> then begins awaiting for the load function <code>Task</code> to complete.
If multiple <code>DataLoaders</code> are used in the operation, their batch <code>Tasks</code> might also schedule
their load function <code>Tasks</code> in the event loop as well. Then each <code>DataLoader's</code>
load function <code>Tasks</code> are executed, until they have all finished running. Then execution
resumes in the one of the batch <code>Tasks</code>, which sets its <code>Futures</code> with the results from the load function.</p>
<p>After a batch <code>Task</code> returns, the resolver <code>Tasks</code> that were waiting for the <code>Futures</code> to be set
from this batch can resume and return the <code>Future</code> results. The other batch <code>Tasks</code> will follow suit
until each batch and resolver <code>Task</code> has finished running. Finally, the <code>gather</code> <code>Future</code> resolves
and fills the response data with the results from each awaitable field resolver.</p>
</div>
</div><footer>
<div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation">
<a class="btn btn-neutral float-left" href="../async/" title="Async Support"><span class="icon icon-circle-arrow-left"></span> Previous</a>
<a class="btn btn-neutral float-right" href="../lifecycle-hooks/" title="Lifecycle Hooks">Next <span class="icon icon-circle-arrow-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span><a href="../async/" style="color: #fcfcfc">Â« Previous</a></span>
<span><a href="../lifecycle-hooks/" style="color: #fcfcfc">Next Â»</a></span>
</span>
</div>
<script src="../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "..";</script>
<script src="../js/theme_extra.js"></script>
<script src="../js/theme.js"></script>
<script src="../js/docs.js"></script>
<script src="../service-worker.js"></script>
<script src="../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
</body>
</html>
